YUI.add("moodle-atto_cloze-button",function(e,t){var n="atto_cloze",r={ANSWER:"cloze_answer",ADD:"cloze_add",CANCEL:"cloze_cancel",DELETE:"cloze_delete",FEEDBACK:"cloze_feedback",FRACTION:"cloze_fraction",MARKS:"cloze_marks",SUBMIT:"cloze_submit",TOLERANCE:"cloze_tolerance",TYPE:"cloze_qtype"},i={FORM:'<div class="atto_cloze"><form class="atto_form"><p>{{qtype}}<span id="{{elementid}}_mark">{{get_string "defaultmark" "core_question"}}</span><input aria-labelledby="{{elementid}}_mark" type="text" class="{{CSS.MARKS}}" value="{{marks}}" /><ol>{{#answerdata}}<li><button class="{{../CSS.ADD}}" title="{{get_string "addmoreanswerblanks" "qtype_calculated"}}">+</button><button class="{{../CSS.DELETE}}" title="{{get_string "delete" "core"}}">-</button><select value="{{fraction}}" class="{{../CSS.FRACTION}}" selected><option value="{{fraction}}">{{fraction}}%</option>{{#../fractions}}<option value="{{fraction}}">{{fraction}}%</option>{{/../fractions}}</select><label for="{{elementid}}_answer">{{get_string "answer" "core"}}</label><input id="{{elementid}}_answer" type="text" class="{{../CSS.ANSWER}}" value="{{answer}}" />{{#if ../numerical}}<label for="{{elementid}}_tolerance">{{{get_string "tolerance" "qtype_calculated"}}}</label><input id="{{elementid}}_tolerance" type="text" class="{{../../CSS.TOLERANCE}}" value="{{tolerance}}" />{{/if}}<label for="{{elementid}}_feedback">{{get_string "feedback" "core"}}</label><input id="{{elementid}}_feedback type="text" class="{{../CSS.FEEDBACK}}" value="{{feedback}}" /></li>{{/answerdata}}</ol><p><button class="{{CSS.ADD}}" title="{{get_string "addmoreanswerblanks" "qtype_calculated"}}">+</button></p><p><button type="submit" class="{{CSS.SUBMIT}}">{{get_string "common:insert" "editor_tinymce"}}</button><button type="submit" class="{{CSS.CANCEL}}">{{get_string "cancel" "core"}}</button></p></form></div>',OUTPUT:"&#123;{{marks}}:{{qtype}}:{{#answerdata}}~%{{fraction}}%{{answer}}{{#if tolerance}}:{{tolerance}}{{/if}}{{#if feedback}}#{{feedback}}{{/if}}{{/answerdata}}&#125;",TYPE:'<div class="atto_cloze">{{#types}}<button class="{{../CSS.TYPE}}" value="{{type}}">{{type}}</button>{{/types}}</div>'},s=[{fraction:100},{fraction:50},{fraction:33.333},{fraction:25},{fraction:20},{fraction:16.667},{fraction:14.2857},{fraction:12.5},{fraction:0},{fraction:-12.5},{fraction:-14.2857},{fraction:-16.667},{fraction:-20},{fraction:-25},{fraction:-33.333},{fraction:-50},{fraction:-100}];e.namespace("M.atto_cloze").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_form:null,_answerdata:null,_qtype:null,_marks:null,_currentSelection:null,initializer:function(){this._groupFocus={};var e=this.get("host").editor.ancestor("form");if(!e||!e.test('[action="question.php"]'))return;this.addButton({icon:"icon",iconComponent:"qtype_multianswer",callback:this._displayDialogue}),this._marks=1,this._answerdata=[{answer:"",feedback:"",fraction:100,tolerance:0}]},_displayDialogue:function(){var e=this.get("host");this._currentSelection=e.getSelection();if(this._currentSelection===!1)return;var t=this.getDialogue({headerContent:M.util.get_string("pluginname",n),bodyContent:'<div style="height:500px"></div>',width:500},!0),r=this._resolveSubquestion();r&&this._parseSubquestion(r),t.show(),t.set("bodyContent",this._getDialogueContent()),this._dialogue=t},_getDialogueContent:function(){var t,n;return this._qtype?(t=e.Handlebars.compile(i.FORM),n=e.Node.create(t({CSS:r,answerdata:this._answerdata,elementid:e.guid(),fractions:s,qtype:this._qtype,marks:this._marks,numerical:this._qtype==="NUMERICAL"||this._qtype==="NM"})),this._form=n,n.one("."+r.SUBMIT).on("click",this._setSubquestion,this),n.one("."+r.CANCEL).on("click",this._cancel,this),n.delegate("click",this._deleteAnswer,"."+r.DELETE,this),n.delegate("click",this._addAnswer,"."+r.ADD,this),n):(t=e.Handlebars.compile(i.TYPE),n=e.Node.create(t({CSS:r,types:[{type:"MULTICHOICE"},{type:"MULTICHOICE_H"},{type:"MULTICHOICE_V"},{type:"MULTICHOICE_S"},{type:"MULTICHOICE_HS"},{type:"MULTICHOICE_VS"},{type:"NUMERICAL"},{type:"SHORTANSWER"}]})),this._form=n,n.delegate("click",function(e){this._qtype=e.target.getAttribute("value"),this._dialogue.set("bodyContent",this._getDialogueContent())},"."+r.TYPE,this),n)},_parseSubquestion:function(e){var t=/\{([0-9]*):([_A-Z]+):(\\.|[^]*?)\}/g,n=t.exec(e);if(!n)return;this._marks=n[1],this._qtype=n[2],this._answerdata=[];var r=n[3].match(/(\\.|[^~])*/g);if(!r)return;console.log(r),r.forEach(function(e){var t=/^(%(-?[\.0-9]+)%|(=?))([^#]*)#(.*)/.exec(e);if(t){if(this._qtype==="NUMERICAL"||this._qtype==="NM"){var n=/^([^:]*):?(.*)/.exec(t[4])[2]||0;this._answerdata.push({answer:t[4].replace(/:.*/,""),feedback:t[5],tolerance:n,fraction:t[3]?100:t[2]||0});return}this._answerdata.push({answer:t[4],feedback:t[5],fraction:t[3]?100:t[2]||0})}},this)},_addAnswer:function(e){e.preventDefault();var t=this._form.all("."+r.ADD).indexOf(e.target);this._getFormData()._answerdata.splice(t,0,{answer:"",feedback:"",fraction:0,tolerance:0}),this._dialogue.set("bodyContent",this._getDialogueContent())},_deleteAnswer:function(e){e.preventDefault();var t=this._form.all("."+r.DELETE).indexOf(e.target);this._getFormData()._answerdata.splice(t,1),this._dialogue.set("bodyContent",this._getDialogueContent())},_cancel:function(e){e.preventDefault(),delete this._qtype,this._dialogue.hide()},_setSubquestion:function(t){t.preventDefault();var n=e.Handlebars.compile(i.OUTPUT);this._getFormData();var s=n({CSS:r,answerdata:this._answerdata,qtype:this._qtype,marks:this._marks}),o=this.get("host");this._dialogue.hide(),o.focus(),o.setSelection(this._currentSelection),o.insertContentAtFocusPoint(s),delete this._qtype,delete this._answerdata},_getFormData:function(){this._answerdata=[];var e=this._form.all("."+r.ANSWER),t=this._form.all("."+r.FEEDBACK),n=this._form.all("."+r.FRACTION),i=this._form.all("."+r.TOLERANCE);for(var s=0;s<e.size();s++)this._answerdata.push({answer:e.item(s).getDOMNode().value,feedback:t.item(s).getDOMNode().value
,fraction:n.item(s).getDOMNode().value,tolerance:i.item(s)?i.item(s).getDOMNode().value:0}),this._marks=this._form.one("."+r.MARKS).getDOMNode().value;return this},_getAnchor:function(e,t){if(!e.hasChildNodes())return{anchor:e,offset:t};var n=e.firstChild;while(t>n.textContent.length)t-=n.textContent.length,n=n.nextSibling;return this._getAnchor(n,t)},_getOffset:function(e,t){if(!e.contains(t))return;if(e===t)return 0;var n=0,r=e.firstChild;while(!r.contains(t))n+=r.textContent.length,r=r.nextSibling;return n+this._getOffset(t,r)},_resolveSubquestion:function(){var e=this.get("host"),t=e.getSelectionParentNode(),n=/\{[^]*?\}/g;if(!t)return;var r=t.textContent.match(n);if(!r)return;var i,s=this.get("host").getSelection(),o="",u=0;if(!s||s.length===0)return!1;var a=this._getOffset(t,s[0].startContainer)+s[0].startOffset,f=this._getOffset(t,s[0].endContainer)+s[0].endOffset;return r.forEach(function(n){i=t.textContent.indexOf(n,u),u=i+n.length;if(i<a&&f<u){o=n;var r=this._getAnchor(t,i),l=this._getAnchor(t,u);s[0].setStart(r.anchor,r.offset),s[0].setEnd(l.anchor,l.offset),this.get("host").setSelection(s),this._currentSelection=e.getSelection()}},this),o}})},"@VERSION@",{requires:["escape","moodle-tinymce_cloze-editor"]});
