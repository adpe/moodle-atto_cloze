YUI.add("moodle-atto_cloze-button",function(e,t){var n="atto_cloze",r={ANSWER:"cloze_answer",ADD:"cloze_add",CANCEL:"cloze_cancel",DELETE:"cloze_delete",FEEDBACK:"cloze_feedback",FRACTION:"cloze_fraction",MARKS:"cloze_marks",SUBMIT:"cloze_submit",TYPE:"cloze_qtype"},i={FORM:'<div class="atto_cloze"><p>{{qtype}}<form class="atto_form">    <label for="{{elementid}}_mark">{{get_string "defaultmark" "core_question"}}</label>    <input id="{{elementid}}_mark" type="text" class="'+r.MARKS+'" value="{{marks}}" />'+"{{#answerdata}}"+"<div>"+'    <button class="'+r.ADD+'" title="{{get_string "addmoreanswerblanks" "qtype_calculated"}}">+</button>'+'    <button class="'+r.DELETE+'" title="{{get_string "delete" "core"}}">-</button>'+'    <select value="{{fraction}}" class="'+r.FRACTION+'">'+'        <option value="{{fraction}}">{{fraction}}%</option>'+'        <option value="100">100%</option>'+'        <option value="50">50%</option>'+'        <option value="33.333">33.333%</option>'+'        <option value="25">25%</option>'+'        <option value="20">20%</option>'+'        <option value="16.6667">16.6667%</option>'+'        <option value="14.2857">14.2857%</option>'+'        <option value="12.5">12.5%</option>'+'        <option value="0">0%</option>'+'        <option value="-12.5">-12.5%</option>'+'        <option value="-14.2857">-14.2857%</option>'+'        <option value="-16.6667">-16.6667%</option>'+'        <option value="-20">-20%</option>'+'        <option value="-25">-25%</option>'+'        <option value="-33.333">-33.333%</option>'+'        <option value="-50">-50%</option>'+'        <option value="-100">-100%</option>'+"    </select>"+'    <label for="{{elementid}}_answer">{{get_string "answer" "core"}}</label>'+'    <input id="{{elementid}}_answer" type="text" class="'+r.ANSWER+'" value="{{answer}}" />'+'    <label for="{{elementid}}_feedback">{{get_string "feedback" "core"}}</label>'+'    <input id="{{elementid}}_feedback type="text" class="'+r.FEEDBACK+'" value="{{feedback}}" />'+"</div>"+"{{/answerdata}}"+'    <p><button class="'+r.ADD+'" title="{{get_string "addmoreanswerblanks" "qtype_calculated"}}">+</button></p>'+'    <p><button type="submit" class="'+r.SUBMIT+'">{{get_string "common:insert" "editor_tinymce"}}</button>'+'    <button type="submit" class="'+r.CANCEL+'">{{get_string "cancel" "core"}}</button></p>'+"</form>"+"</div>",OUTPUT:"&#123;{{marks}}:{{qtype}}:{{#answerdata}}~%{{fraction}}%{{answer}}#{{feedback}}{{/answerdata}}&#125;",TYPE:'<div class="atto_cloze">{{#types}}<button class="'+r.TYPE+'" value="{{type}}">{{type}}</button>'+"{{/types}}"+"</div>"};e.namespace("M.atto_cloze").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_form:null,_answerdata:null,_qtype:null,_marks:null,_currentSelection:null,initializer:function(){this._groupFocus={};var e=this.get("host").editor.ancestor("form");if(!e||!e.test('[action="question.php"]'))return;this.addButton({icon:"icon",iconComponent:"qtype_multianswer",callback:this._displayDialogue}),this._marks=1,this._answerdata=[{answer:"",feedback:"",fraction:100}]},_displayDialogue:function(){var e=this.get("host");this._currentSelection=e.getSelection();if(this._currentSelection===!1)return;var t=this.getDialogue({headerContent:M.util.get_string("pluginname",n),bodyContent:'<div style="height:500px"></div>',width:500},!0),r=this._resolveSubquestion();r&&this._parseSubquestion(r),t.show(),t.set("bodyContent",this._getDialogueContent()),this._dialogue=t},_getDialogueContent:function(){var t,n;return this._qtype?(t=e.Handlebars.compile(i.FORM),n=e.Node.create(t({answerdata:this._answerdata,qtype:this._qtype,marks:this._marks})),this._form=n,n.one("."+r.SUBMIT).on("click",this._setSubquestion,this),n.one("."+r.CANCEL).on("click",this._setSubquestion,this),n.delegate("click",this._deleteAnswer,"."+r.DELETE,this),n.delegate("click",this._addAnswer,"."+r.ADD,this),n):(t=e.Handlebars.compile(i.TYPE),n=e.Node.create(t({types:[{type:"MULTICHOICE"},{type:"MULTICHOICE_H"},{type:"MULTICHOICE_V"},{type:"MULTICHOICE_S"},{type:"MULTICHOICE_HS"},{type:"MULTICHOICE_VS"},{type:"NUMERICAL"},{type:"SHORTANSWER"}]})),this._form=n,n.delegate("click",function(e){this._qtype=e.target.getAttribute("value"),this._dialogue.set("bodyContent",this._getDialogueContent())},"."+r.TYPE,this),n)},_parseSubquestion:function(e){var t=/\{([0-9]*):([_A-Z]*):(\\.|[^]*?)\}/g,n=t.exec(e);if(!n)return;this._marks=n[1],this._qtype=n[2],this._answerdata=[];var r=n[3].match(/(\\.|[^~])*/g);if(!r)return;r.forEach(function(e){var t=/^(%(-?[\.0-9]+)%|(=?))([^#]*)#(.*)/.exec(e);t&&this._answerdata.push({answer:t[4],feedback:t[5],fraction:t[3]?100:t[2]||0})},this)},_addAnswer:function(e){e.preventDefault();var t=this._form.all("."+r.ADD).indexOf(e.target);this._getFormData()._answerdata.splice(t,0,{answer:"",feedback:"",fraction:0}),this._dialogue.set("bodyContent",this._getDialogueContent())},_deleteAnswer:function(e){e.preventDefault();var t=this._form.all("."+r.DELETE).indexOf(e.target);this._getFormData()._answerdata.splice(t,1),this._dialogue.set("bodyContent",this._getDialogueContent())},_cancel:function(e){e.preventDefault(),delete this._qtype},_setSubquestion:function(t){t.preventDefault();var n=e.Handlebars.compile(i.OUTPUT);this._getFormData();var r=n({answerdata:this._answerdata,qtype:this._qtype,marks:this._marks}),s=this.get("host");this._dialogue.hide(),s.focus(),s.setSelection(this._currentSelection),s.insertContentAtFocusPoint(r),delete this._qtype,delete this._answerdata},_getFormData:function(){this._answerdata=[];var e=this._form.all("."+r.ANSWER),t=this._form.all("."+r.FEEDBACK),n=this._form.all("."+r.FRACTION);for(var i=0;i<e.size();i++)this._answerdata.push({answer:e.item(i).getDOMNode().value,feedback:t.item(i).getDOMNode().value,fraction:n.item(i).getDOMNode().value}),this._marks=this._form.one("."+r.MARKS).getDOMNode().value;return this},_getAnchor:function(e,t){if(!e.hasChildNodes())return{anchor:e,offset:t};var n=e.firstChild;while(t>n.textContent
.length)t-=n.textContent.length,n=n.nextSibling;return this._getAnchor(n,t)},_getOffset:function(e,t){if(!e.contains(t))return;if(e===t)return 0;var n=0,r=e.firstChild;while(!r.contains(t))n+=r.textContent.length,r=r.nextSibling;return n+this._getOffset(t,r)},_resolveSubquestion:function(){var e=this.get("host"),t=e.getSelectionParentNode(),n=/\{[^]*?\}/g;if(!t)return;var r=t.textContent.match(n);if(!r)return;var i,s=this.get("host").getSelection(),o="",u=0;if(!s||s.length===0)return!1;var a=this._getOffset(t,s[0].startContainer)+s[0].startOffset,f=this._getOffset(t,s[0].endContainer)+s[0].endOffset;return r.forEach(function(n){i=t.textContent.indexOf(n,u),u=i+n.length;if(i<a&&f<u){o=n;var r=this._getAnchor(t,i),l=this._getAnchor(t,u);s[0].setStart(r.anchor,r.offset),s[0].setEnd(l.anchor,l.offset),this.get("host").setSelection(s),this._currentSelection=e.getSelection()}},this),o}})},"@VERSION@",{requires:["escape","moodle-tinymce_cloze-editor"]});
